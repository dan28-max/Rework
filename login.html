<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spartan Data - Login</title>
    <link rel="stylesheet" href="login-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>
</head>
<body>
    <div class="login-container">
        <a href="landing.html" class="back-to-home">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Home</span>
        </a>
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <img src="image/BatStateU-NEU-Logo.png" alt="BatStateU Logo" class="logo-img">
                </div>
            </div>

            <form class="login-form" id="loginForm">
                <div class="form-header">
                    <h2>Login</h2>
                    <p>Enter your credentials to access the system</p>
                </div>

                <div class="form-group">
                    <label for="username">Username</label>
                    <div class="input-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="username" name="username" placeholder="Enter your username" required autocomplete="username">
                    </div>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-group password-input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" name="password" placeholder="Enter your password" required>
                        <button type="button" class="password-toggle-inside" id="passwordToggle">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <span class="checkmark"></span>
                        Remember me
                    </label>
                    <a href="#" class="forgot-password">Forgot Password?</a>
                </div>

                <!-- reCAPTCHA -->
                <div class="recaptcha-container">
                    <div class="g-recaptcha" id="recaptchaWidget"></div>
                </div>

                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    Login
                </button>
            </form>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText">Invalid credentials. Please try again.</span>
            </div>

            <!-- Success Message -->
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i>
                <span id="successText">Login successful! Redirecting...</span>
            </div>
        </div>

        <div class="login-footer">
            <p>&copy; 2024 Spartan Data. All rights reserved.</p>
        </div>
    </div>

    <script>
        // Global callback function for reCAPTCHA onload
        function onRecaptchaLoad() {
            console.log('reCAPTCHA API loaded');
            loadRecaptcha();
        }
        
        // Load reCAPTCHA site key dynamically
        function loadRecaptcha() {
            const recaptchaDiv = document.getElementById('recaptchaWidget');
            if (!recaptchaDiv) {
                console.error('reCAPTCHA widget container not found');
                return;
            }
            
            // Check if grecaptcha is available
            if (typeof grecaptcha === 'undefined') {
                console.log('grecaptcha not yet available, waiting...');
                setTimeout(loadRecaptcha, 100);
                return;
            }
            
            // Determine the correct API path
            const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
            const apiPath = basePath + '/api/get_recaptcha_config.php';
            
            console.log('Loading reCAPTCHA config from:', apiPath);
            
            // Fetch site key from API
            fetch(apiPath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch reCAPTCHA config: ' + response.status);
                    }
                    return response.json();
                })
                .then(config => {
                    console.log('reCAPTCHA config received:', config);
                    
                    if (config.success && config.siteKey && config.siteKey !== 'your-site-key-here') {
                        console.log('Rendering reCAPTCHA with site key:', config.siteKey);
                        
                        // Render reCAPTCHA widget and store widget ID
                        try {
                            const widgetId = grecaptcha.render(recaptchaDiv, {
                                'sitekey': config.siteKey,
                                'callback': function() {
                                    console.log('reCAPTCHA rendered successfully');
                                },
                                'error-callback': function() {
                                    console.error('reCAPTCHA error: Invalid key type or domain not registered');
                                    alert('reCAPTCHA Error: Please check that:\n1. Site Key and Secret Key match\n2. Domain (localhost) is registered in reCAPTCHA admin\n3. Keys are for reCAPTCHA v2 checkbox type');
                                }
                            });
                            // Store widget ID for later retrieval
                            recaptchaDiv.setAttribute('data-widget-id', widgetId);
                            console.log('reCAPTCHA widget ID:', widgetId);
                        } catch (error) {
                            console.error('Error rendering reCAPTCHA:', error);
                            alert('reCAPTCHA Error: ' + error.message + '\n\nPlease verify your keys in config/recaptcha.php');
                        }
                    } else {
                        console.warn('reCAPTCHA site key not configured or invalid');
                    }
                })
                .catch(error => {
                    console.error('Failed to load reCAPTCHA config:', error);
                    // Try fallback paths
                    const fallbackPaths = [
                        './api/get_recaptcha_config.php',
                        'api/get_recaptcha_config.php',
                        '/rework/api/get_recaptcha_config.php'
                    ];
                    
                    let fallbackIndex = 0;
                    function tryFallback() {
                        if (fallbackIndex >= fallbackPaths.length) {
                            console.error('All reCAPTCHA config paths failed');
                            return;
                        }
                        
                        const fallbackPath = fallbackPaths[fallbackIndex++];
                        console.log('Trying fallback path:', fallbackPath);
                        
                        fetch(fallbackPath)
                            .then(response => {
                                if (!response.ok) throw new Error('HTTP ' + response.status);
                                return response.json();
                            })
                            .then(config => {
                                if (config.success && config.siteKey && config.siteKey !== 'your-site-key-here') {
                                    if (typeof grecaptcha !== 'undefined') {
                                        const widgetId = grecaptcha.render(recaptchaDiv, {
                                            'sitekey': config.siteKey,
                                            'error-callback': function() {
                                                console.error('reCAPTCHA error: Invalid key type or domain not registered');
                                            }
                                        });
                                        recaptchaDiv.setAttribute('data-widget-id', widgetId);
                                        console.log('reCAPTCHA loaded via fallback path');
                                    }
                                } else {
                                    tryFallback();
                                }
                            })
                            .catch(err => {
                                console.error('Fallback path failed:', fallbackPath, err);
                                tryFallback();
                            });
                    }
                    
                    tryFallback();
                });
        }
        
        // Also try loading if page is already loaded
        if (document.readyState !== 'loading') {
            if (typeof grecaptcha !== 'undefined') {
                loadRecaptcha();
            }
        }
    </script>
    <script src="login-script.js"></script>
</body>
</html>
